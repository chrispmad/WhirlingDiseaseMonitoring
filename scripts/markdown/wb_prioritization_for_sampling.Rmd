---
title: "Prioritization of Water Bodies for Whirling Disease Sampling"
author: "Chris Madsen & John Phelan"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
library(tidyverse)
library(readxl)
library(BAMMtools)
base_dir = stringr::str_extract(getwd(),"C:\\/Users\\/[a-zA-Z]+")
onedrive_wd = paste0(str_extract(getwd(),"C:/Users/[A-Z]+/"),"OneDrive - Government of BC/data/")
lan_root = "//SFP.IDIR.BCGOV/S140/S40203/WFC AEB/General/"


bin_to_natural_breaks = function(dat,variable){
  # find natural breaks ("jenks")
  nbreaks = BAMMtools::getJenksBreaks(var = dat[[variable]], k = 4)
  dat |> 
    dplyr::rename(var_to_bin = !!rlang::sym(variable)) |> 
    dplyr::mutate(var_bin = as.numeric(cut(var_to_bin,nbreaks))) |> 
    dplyr::mutate(var_bin = tidyr::replace_na(var_bin, 1)) |> 
    dplyr::mutate(var_bin = as.character(var_bin)) |> 
    dplyr::mutate(var_bin = factor(var_bin, levels = c(1:3))) |> 
    dplyr::rename(!!rlang::sym(paste0(variable,"_bin")) := var_bin,
                  !!rlang::sym(variable) := var_to_bin)
}
```

### Watercraft Inspections Coming from Infected States/Provinces

```{r watercraft_insp_from_inf_areas}
insp_from_wd_inf_to_wb = sf::read_sf("W:/CMadsen/Projects/ZQMussels/data/Waterbodies_with_Inspection_Data_Summaries_all_years_WD_Infected_Areas.gpkg")
# Note: the above file can kind of only be modified / updated on Chris' computer, as it depends on the ZQMussels R project (specifically, it's Options.csv file) and the {imdp} R package... but the output gets saved to Chris' W drive, so that should be accessible for everyone!

insp_from_wd_inf_to_wb_b = bin_to_natural_breaks(insp_from_wd_inf_to_wb, 'TotalInspections')

# Strip out pacific ocean and 'dry storage' destinations for watercraft.
insp_from_wd_inf_to_wb_b = insp_from_wd_inf_to_wb_b |> 
  dplyr::filter(!GNIS_NA %in% c("Pacific Ocean","Dry Storage"))

bins_title = BAMMtools::getJenksBreaks(var = insp_from_wd_inf_to_wb$TotalInspections, k = 4)

# Plot showing binned numbers of watercraft headed to waterbodies in BC from infected states / provinces as well as infected waterbodies in BC.
ggplot() + 
  geom_sf(data = bcmaps::bc_bound()) +
  geom_sf(data = insp_from_wd_inf_to_wb_b, aes(fill = TotalInspections_bin,
                                             col = TotalInspections_bin)) + 
  ggthemes::theme_map() + 
  scale_fill_brewer(palette = 'Spectral', direction = -1) +
  scale_color_brewer(palette = 'Spectral', direction = -1) + 
  labs(color = 'Inspections (bin)',
       fill = 'Inspections (bin)',
       subtitle = paste0("Inspection Bins: 1 ('low', ",
                         bins_title[1]," to ",bins_title[2],
                         "), 2 ('medium', ",
                         bins_title[2]," to ",bins_title[3],
                         "), 3 ('high', ",
                         bins_title[3]," to ",bins_title[4],
                         ")"))
```

### Watercraft Inspections Coming from Infected Waterbodies in BC

```{r watercraft_insp_from_inf_wbs_in_bc}
insp_from_wd_bc_wb = sf::read_sf("W:/CMadsen/Projects/ZQMussels/data/Waterbodies_with_Inspection_Data_Summaries_all_years_BC_WD_Infected_Waterbodies.gpkg")
# Note: the above file can kind of only be modified / updated on Chris' computer, as it depends on the ZQMussels R project (specifically, it's Options.csv file) and the {imdp} R package... but the output gets saved to Chris' W drive, so that should be accessible for everyone!

insp_from_wd_bc_wb_b = bin_to_natural_breaks(insp_from_wd_bc_wb, 'TotalInspections')

# Strip out pacific ocean and 'dry storage' destinations for watercraft.
insp_from_wd_bc_wb_b = insp_from_wd_bc_wb_b |> 
  dplyr::filter(!GNIS_NA %in% c("Pacific Ocean","Dry Storage"))

bins_title_bc = BAMMtools::getJenksBreaks(var = insp_from_wd_bc_wb_b$TotalInspections, k = 4)

# Plot showing binned numbers of watercraft headed to waterbodies in BC from infected states / provinces as well as infected waterbodies in BC.
ggplot() + 
  geom_sf(data = bcmaps::bc_bound()) +
  geom_sf(data = insp_from_wd_bc_wb_b, aes(fill = TotalInspections_bin,
                                             col = TotalInspections_bin)) + 
  ggthemes::theme_map() + 
  scale_fill_brewer(palette = 'Spectral', direction = -1) +
  scale_color_brewer(palette = 'Spectral', direction = -1) + 
  labs(color = 'Inspections (bin)',
       fill = 'Inspections (bin)',
       subtitle = paste0("Inspection Bins: 1 ('low', ",
                         bins_title_bc[1]," to ",bins_title_bc[2],
                         "), 2 ('medium', ",
                         bins_title_bc[2]," to ",bins_title_bc[3],
                         "), 3 ('high', ",
                         bins_title_bc[3]," to ",bins_title_bc[4],
                         ")"))
```

			iii. Bin angler use in the same way as i.
			iv. Presence/absence of hatcheries (doesn't contribute to score)

```{r hatchery raster}
hatchery_rast<-terra::rast(paste0(onedrive_wd,"raster/aquaculture_presence_absence_raster.tif"))
#plot


hatchery_points <- terra::as.points(hatchery_rast, na.rm = TRUE)

hatchery_sf <- sf::st_as_sf(hatchery_points)


ggplot() +
  geom_sf(data = bcmaps::bc_bound()) +
  geom_sf(data = hatchery_sf, aes(color = sum), size = 1) +
  scale_color_viridis_c(option = "magma") +
  ggthemes::theme_map() +
  labs(color = 'Hatchery Presence/Absence',
       subtitle = "Hatcheries are present in the areas with a value of 1")

```

			
			
			v. True/False for "is target WB in subwatershed with positive fish" (doesn't contribute to score)
			vi. Overlay eDNA results for tubifex
			vii. If tubifex density is accurate, overlay tubifex density map binned into presence/absence (doesn't contribute to score)
			viii. Overlay susceptible species occurrences (present/absent for each waterbody) and facet map by species at this stage; maybe later we'll remove WBs with 0. We could apply this and show the effect of doing this.
			ix. Add in expert opinion from regions, First Nations, etc., as available
			x. In future, we'll bring in SARA-listed species / COSEWIC
