---
title: "Prioritization of Water Bodies for Whirling Disease Sampling"
author: "Chris Madsen & John Phelan"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
library(tidyverse)
library(readxl)
library(BAMMtools)
library(terra)
#devtools::install_github("yutannihilation/ggsflabel")
library(ggsflabel)
library(tidyterra)
library(sf)


requery_occs = F

base_dir = stringr::str_extract(getwd(),"C:\\/Users\\/[a-zA-Z]+")
onedrive_wd = paste0(str_extract(getwd(),"C:/Users/[A-Z]+/"),"OneDrive - Government of BC/data/")
lan_root = "//SFP.IDIR.BCGOV/S140/S40203/WFC AEB/General/"
proj_wd = getwd()
if(stringr::str_detect(proj_wd,"scripts")){
  proj_wd = stringr::str_remove(proj_wd, "/scripts")
}

# This function finds the natural breaks (or, "Jenks") for a numeric column
bin_to_natural_breaks = function(dat,variable){
  # find natural breaks ("jenks")
  nbreaks = BAMMtools::getJenksBreaks(var = dat[[variable]], k = 4)
  dat |> 
    dplyr::rename(var_to_bin = !!rlang::sym(variable)) |> 
    dplyr::mutate(var_bin = as.numeric(cut(var_to_bin,nbreaks))) |> 
    dplyr::mutate(var_bin = tidyr::replace_na(var_bin, 1)) |> 
    dplyr::mutate(var_bin = as.character(var_bin)) |> 
    dplyr::mutate(var_bin = factor(var_bin, levels = c(1:3))) |> 
    dplyr::rename(!!rlang::sym(paste0(variable,"_bin")) := var_bin,
                  !!rlang::sym(variable) := var_to_bin)
}

## GGplot label convenience function
bin_info_labs = function(bins_title){
    labs(color = 'Inspections (bin)',
       fill = 'Inspections (bin)',
       subtitle = paste0("Inspection Bins: 1 ('low', ",
                         bins_title[1]," to ",bins_title[2],
                         "), 2 ('medium', ",
                         bins_title[2]," to ",bins_title[3],
                         "), 3 ('high', ",
                         bins_title[3]," to ",bins_title[4],
                         ")"))
}
```

## Initial Waterbody list {.tabset}

### Watercraft Inspections Coming from Infected States/Provinces

These are binned watercraft inspections originating from infected states or provinces, as well as from waterbodies in British Columbia (BC) that are infected with whirling disease. The bins represent the number of watercraft headed to BC waterbodies from infected states, provinces, or infected BC waterbodies.

```{r watercraft_insp_from_inf_areas}
insp_from_wd_inf_to_wb = sf::read_sf("W:/CMadsen/Projects/ZQMussels/data/Waterbodies_with_Inspection_Data_Summaries_all_years_WD_Infected_Areas.gpkg")
# Note: the above file can kind of only be modified / updated on Chris' computer, as it depends on the ZQMussels R project (specifically, it's Options.csv file) and the {imdp} R package... but the output gets saved to Chris' W drive, so that should be accessible for everyone!

# Tentative # 
# We could maybe use this version / cut of waterbodies in BC, add to it at each step, and that could be our list of waterbodies? #

insp_from_wd_inf_to_wb_b = bin_to_natural_breaks(insp_from_wd_inf_to_wb, 'TotalInspections')

# Strip out pacific ocean and 'dry storage' destinations for watercraft.
insp_from_wd_inf_to_wb_b = insp_from_wd_inf_to_wb_b |> 
  dplyr::filter(!GNIS_NA %in% c("Pacific Ocean","Dry Storage"))

bins_title = BAMMtools::getJenksBreaks(var = insp_from_wd_inf_to_wb$TotalInspections, k = 4)

# Plot showing binned numbers of watercraft headed to waterbodies in BC from infected states / provinces as well as infected waterbodies in BC.
ggplot() + 
  geom_sf(data = bcmaps::bc_bound()) +
  geom_sf(data = insp_from_wd_inf_to_wb_b, aes(fill = TotalInspections_bin,
                                             col = TotalInspections_bin)) + 
  ggthemes::theme_map() + 
  scale_fill_brewer(palette = 'Spectral', direction = -1) +
  scale_color_brewer(palette = 'Spectral', direction = -1) + 
  labs(color = 'Inspections (bin)',
       fill = 'Inspections (bin)',
       subtitle = paste0("Inspection Bins: 1 ('low', ",
                         bins_title[1]," to ",bins_title[2],
                         "), 2 ('medium', ",
                         bins_title[2]," to ",bins_title[3],
                         "), 3 ('high', ",
                         bins_title[3]," to ",bins_title[4],
                         ")"))

wb_list = insp_from_wd_inf_to_wb_b |> 
  dplyr::select(GNIS_NA, WATERSH, TotalInspections, TotalInspections_bin)
```

Currently, the number of distinct waterbodies with information is `r nrow(wb_list)`.

### Watercraft Inspections Coming from Infected Waterbodies in BC

These are where boats are going when coming from infected BC waterbodies.

```{r watercraft_insp_from_inf_wbs_in_bc}
insp_from_wd_bc_wb = sf::read_sf("W:/CMadsen/Projects/ZQMussels/data/Waterbodies_with_Inspection_Data_Summaries_all_years_BC_WD_Infected_Waterbodies.gpkg")
# Note: the above file can kind of only be modified / updated on Chris' computer, as it depends on the ZQMussels R project (specifically, it's Options.csv file) and the {imdp} R package... but the output gets saved to Chris' W drive, so that should be accessible for everyone!

insp_from_wd_bc_wb_b = bin_to_natural_breaks(insp_from_wd_bc_wb, 'TotalInspections')

# Strip out pacific ocean and 'dry storage' destinations for watercraft.
insp_from_wd_bc_wb_b = insp_from_wd_bc_wb_b |> 
  dplyr::filter(!GNIS_NA %in% c("Pacific Ocean","Dry Storage"))

bins_title_bc = BAMMtools::getJenksBreaks(var = insp_from_wd_bc_wb_b$TotalInspections, k = 4)

# Plot showing binned numbers of watercraft headed to waterbodies in BC from infected states / provinces as well as infected waterbodies in BC.
ggplot() + 
  geom_sf(data = bcmaps::bc_bound()) +
  geom_sf(data = insp_from_wd_bc_wb_b, aes(fill = TotalInspections_bin,
                                             col = TotalInspections_bin)) + 
  ggthemes::theme_map() + 
  scale_fill_brewer(palette = 'Spectral', direction = -1) +
  scale_color_brewer(palette = 'Spectral', direction = -1) + 
  labs(color = 'Inspections (bin)',
       fill = 'Inspections (bin)',
       subtitle = paste0("Inspection Bins: 1 ('low', ",
                         bins_title_bc[1]," to ",bins_title_bc[2],
                         "), 2 ('medium', ",
                         bins_title_bc[2]," to ",bins_title_bc[3],
                         "), 3 ('high', ",
                         bins_title_bc[3]," to ",bins_title_bc[4],
                         ")"))

# Identify any water bodies that aren't already in the list.
new_wb_for_list = insp_from_wd_bc_wb_b |> 
  dplyr::anti_join(
    wb_list |> 
      sf::st_drop_geometry() |> 
      dplyr::select(GNIS_NA, WATERSH)
  ) |> 
  dplyr::select(GNIS_NA, WATERSH,
                insp_from_wd_bc_wb = TotalInspections,
                insp_from_wd_bc_wb_b = TotalInspections_bin)

wb_already_in_list = insp_from_wd_bc_wb_b |> 
  dplyr::filter(paste0(WATERSH,GNIS_NA) %in% paste0(wb_list$WATERSH,wb_list$GNIS_NA)) |> 
  dplyr::select(GNIS_NA, WATERSH, insp_from_wd_bc_wb = TotalInspections,
                insp_from_wd_bc_wb_b = TotalInspections_bin) |> 
  sf::st_drop_geometry()

# Not new waterbodies per list, per se, but new columns.
wb_list = wb_list |> 
  dplyr::left_join(
    wb_already_in_list
  )

# Are there any new waterbodies to be added to the wb_list?
if(nrow(new_wb_for_list) > 0){
  wb_list = wb_list |> 
    dplyr::bind_rows(
      new_wb_for_list
    )
}
```

Currently, the number of distinct waterbodies with information is `r nrow(wb_list)`.

### Freshwater Fisheries Society Angler Survey (2022-2023)



```{r}
# We do have angler use as a raster on onedrive, but we also have the original polygon object on the W: drive.
# ang = terra::rast(paste0(onedrive_wd,"CNF/DFO_angling_survey_days_fished_raster.tif"))
ang = sf::read_sf("W:/CMadsen/shared_data_sets/freshwater_fisheries_society_angler_survey_2022_2023.gpkg")

# Drop waterbodies with no fishing
ang = ang |> 
  dplyr::filter(!is.na(days_fished))

# Rename some columns.
ang = ang |> 
  dplyr::rename(WATERSH = WATERSHED_GROUP_ID,
                GNIS_NA = Waterbody)

# Summarise at the waterbody name and watershed number level.
ang_s = ang |> 
  dplyr::group_by(GNIS_NA, WATERSH) |> 
  dplyr::summarise(days_fished = sum(days_fished,na.rm=T)) |> 
  dplyr::ungroup()

ang_s = bin_to_natural_breaks(ang_s, "days_fished")

bins_title_ang = BAMMtools::getJenksBreaks(ang_s$days_fished, k = 4)

ggplot() + 
  geom_sf(data = bcmaps::bc_bound()) +
  geom_sf(data = ang_s, aes(col = days_fished_bin, fill = days_fished_bin)) + 
  ggthemes::theme_map() + 
  bin_info_labs(bins_title_ang)

# Identify any water bodies that aren't already in the list.
new_wb_for_list = ang_s |> 
  dplyr::anti_join(
    wb_list |> 
      sf::st_drop_geometry() |> 
      dplyr::select(GNIS_NA, WATERSH)
  ) |> 
  dplyr::select(WATERSH, GNIS_NA, days_fished, days_fished_bin)

wb_already_in_list = ang_s |> 
  dplyr::filter(paste0(WATERSH,GNIS_NA) %in% paste0(wb_list$WATERSH,wb_list$GNIS_NA)) |> 
  dplyr::select(GNIS_NA, WATERSH, days_fished, days_fished_bin) |> 
  sf::st_drop_geometry()

# Not new waterbodies per list, per se, but new columns.
wb_list = wb_list |> 
  dplyr::left_join(
    wb_already_in_list
  )

# Are there any new waterbodies to be added to the wb_list?
if(nrow(new_wb_for_list) > 0){
  wb_list = wb_list |> 
    dplyr::bind_rows(
      new_wb_for_list
    )
}
```

Currently, the number of distinct waterbodies with information is `r nrow(wb_list)`.

### Hatchery Locations

Locations of salmond hatcheries across the province.

```{r hatchery raster}
hatchery_rast<-terra::rast(paste0(onedrive_wd,"raster/aquaculture_presence_absence_raster.tif"))
#plot

hatchery_points <- terra::as.points(hatchery_rast, na.rm = TRUE)

hatchery_sf <- sf::st_as_sf(hatchery_points)

# Filter to only presence points (value = 1)
hatchery_presence_sf <- hatchery_sf[hatchery_sf$sum == 1, ] |> 
  dplyr::rename(hatchery_present = sum)

# Plot with a single color and simplified legend
ggplot() +
  geom_sf(data = bcmaps::bc_bound()) +
  geom_sf(data = hatchery_presence_sf, color = "darkred", size = 1) +
  ggthemes::theme_map() +
  labs(color = NULL, subtitle = "Hatchery Presence in BC") +
  theme(legend.position = "none")

# Add in overlap of hatcheries to wb_list
hatcheries_by_wb = hatchery_presence_sf |> 
      sf::st_transform(3005) |> 
  sf::st_join(wb_list |> dplyr::select(GNIS_NA,WATERSH)) |> 
  sf::st_drop_geometry() |> 
  dplyr::filter(!is.na(GNIS_NA)) |> 
  dplyr::group_by(GNIS_NA, WATERSH) |> 
  dplyr::reframe(hatchery_present = sum(hatchery_present))

wb_list = wb_list |> 
  dplyr::left_join(
    hatcheries_by_wb
  )
```

### Watershed Groups with Positive Fish eDNA Detection


```{r}
ws = sf::read_sf("W:/CMadsen/shared_data_sets/subwatersheds_BC.shp")


edna_results = readxl::read_excel(paste0(lan_root,"2 SCIENCE - Invasives/SPECIES/Whirling Disease/Monitoring/WD_sampling_results_fish_eDNA_used_for_making_maps_CMADSEN.xlsx")) |> 
  purrr::set_names(snakecase::to_snake_case)

pos_fish_edna = edna_results |> 
  dplyr::filter(stringr::str_detect(fish_sampling_results_q_pcr_mc_detected, 'Positive'))

pos_fish_edna_sf = sf::st_as_sf(pos_fish_edna,coords = c('long','lat'), crs = 4326)

# Also pull in emerald lake, find its centroid.
emerald_lake = bcdata::bcdc_query_geodata('freshwater-atlas-lakes') |> 
  bcdata::filter(GNIS_NAME_1 == 'Emerald Lake', WATERBODY_POLY_ID == 705013945) |> 
  collect()

emerald_lake_centroid = emerald_lake |> 
  sf::st_centroid()

ws_w_edna_fish = ws |> 
  sf::st_filter(
    pos_fish_edna_sf |> 
      sf::st_transform(3005) |> 
      dplyr::bind_rows(emerald_lake_centroid)
  )

ws_bbox = sf::st_bbox(ws_w_edna_fish |> sf::st_buffer(dist = 50000))

ggplot() + 
  geom_sf(data = bcmaps::bc_bound()) + 
  geom_sf(data = ws_w_edna_fish, aes(fill = "Positive Fish \neDNA Results")) +
  geom_sf(data = pos_fish_edna_sf, col = 'lightgreen') + 
  geom_sf(data = emerald_lake, fill = 'lightgreen', col = 'lightgreen') + 
  geom_sf_label(data = emerald_lake, aes(label = 'Emerald Lake'), nudge_x = 80000) +
  # geom_sf_label(data = pos_fish_edna_sf, aes(label = sample_site_name), nudge_x = 80000, nudge_y = -100000) +
  ggsflabel::geom_sf_label_repel(data = pos_fish_edna_sf,
                                 aes(label = sample_site_name),
                        force = 10, seed = 10) +
  labs(fill = 'eDNA') + 
  coord_sf(xlim = ws_bbox[c(1,3)],
           ylim = ws_bbox[c(2,4)]) + 
  ggthemes::theme_map() + 
  ggspatial::annotation_scale()

wb_list = wb_list |> 
  dplyr::mutate(fish_edna_positive_in_watershed = WATERSH %in% ws_w_edna_fish$WATERSHED_)
```



### Overlay of Positive Tubifex Results

vi. Overlay eDNA results for tubifex

```{r overlay_tubifex_results}

tubifex_results = edna_results |> 
  dplyr::filter(stringr::str_detect(e_dna_results_tubifex, 'Detected'))

tubifex_results_sf = sf::st_as_sf(tubifex_results, coords = c('long','lat'), crs = 4326)

ggplot()+
  geom_sf(data = bcmaps::bc_bound()) + 
  geom_sf(data = tubifex_results_sf, aes(col = e_dna_results_tubifex)) +
  labs(col = 'Tubifex \neDNA Results') + 
  scale_color_brewer(palette = "Set1") +
  ggthemes::theme_map() + 
  ggspatial::annotation_scale()+
  theme(legend.position = 'bottom')


ws_w_edna_tubifex = ws |> 
  sf::st_filter(
    tubifex_results_sf |> 
      sf::st_transform(3005) |> 
      dplyr::bind_rows(emerald_lake_centroid)
  )

wb_list = wb_list |> 
  dplyr::mutate(tubifex_edna_positive_in_watershed = WATERSH %in% ws_w_edna_tubifex$WATERSHED_)

```

			
			
			
### Tubifex MaxEnt Model Results

vii. If tubifex density is accurate, overlay tubifex density map binned into presence/absence (doesn't contribute to score)

Maxent produced habitat suitability maps, based on a set of pre-determined parameters. It uses the presences of tubifex to assess the rest of the province and determine where tubifex is likely to be found. This is then assigned value of habitat/not-habitat based on internal fitting of parameters.

```{r tubifex_maxent}

tubifex_maxent<- terra::rast(paste0(proj_wd,"output/habitat_maxent_tubifex_binary_fc.LQ_rm.3.tif"))
#create factors for the values in the raster
tubifex_maxent <- terra::as.factor(tubifex_maxent)


ggplot() +
  tidyterra::geom_spatraster(data = tubifex_maxent) +  # Raster layer
  geom_sf(data = bcmaps::bc_bound(), fill = NA, color = "black") +  # BC boundary
  geom_sf(data = wb_list, color = "blue", alpha = 0.5) +  # Waterbodies
  scale_fill_manual(
    values = c("0" = "lightgreen", "1" = "purple"),
    na.value = "transparent"  # Handle NA values
  ) +
  labs(fill = 'Suitable\nHabitat') +
  ggthemes::theme_map()+
  theme(legend.position = "right",
        plot.background = element_rect(fill = 'lightblue'))


# For the wbs_list, find the overlap with the raster abd add a column for tubifex habitat suitability.
bc_crs <- "EPSG:3005"
tubifex_maxent <- project(tubifex_maxent, bc_crs, method = "near")
wb_vect <- vect(wb_list)
factor_levels <- levels(tubifex_maxent)[[1]]  # Only one layer
extracted <- extract(tubifex_maxent, wb_vect)
extracted <- dplyr::left_join(extracted, factor_levels, by = "fc.LQ_rm.3")




suitability_summary <- extracted |> 
  group_by(ID.x) |> 
  summarize(
    max_val = if (all(is.na(fc.LQ_rm.3))) NA_real_ else max(as.numeric(fc.LQ_rm.3), na.rm = TRUE)
  ) |> 
  mutate(
    tubifex_habitat_suitability = case_when(
      is.na(max_val) ~ NA_character_,
      max_val >= 1 ~ "suitable",
      TRUE ~ "unsuitable"
    )
  )


wb_list$tubifex_habitat_suitability <- suitability_summary$tubifex_habitat_suitability

```

			

			
### Overlay Susceptible Species Occurrences

viii. Overlay susceptible species occurrences (present/absent for each waterbody) and facet map by species at this stage; maybe later we'll remove WBs with 0. We could apply this
			and show the effect of doing this.

The species considered susceptible to whirling disease are:
			
```{r overlay_susceptible_species}

# Fish occurrence records queried from typical data sources.
all_occs = sf::read_sf(paste0(lan_root,"2 SCIENCE - Invasives/SPECIES/5_Incidental Observations/AIS_occurrences_all_sources.gpkg"))
source("grab_occs_updated_path.R")
# rel_occs = all_occs |> 
#   dplyr::filter(Species %in% c("Bull trout","Sockeye salmon"))

# Add queries for Bull Trout and Sockeye Salmon

bc<-bcmaps::bc_bound() |> 
  sf::st_transform(4326)

species_names <- c(
  "Bull Trout", "Sockeye Salmon", "Cutthroat Trout", "Coho Salmon",
  "Rainbow Trout", "Chinook Salmon", "Mountain Whitefish", 
  "Atlantic Salmon", "Brown Trout", "Brook Trout"
)
if(requery_occs){
species_occs <- lapply(species_names, function(sp) {
  ocs<-suppressMessages(suppressWarnings(grab_aq_occ_data_path_update(sp, quiet = TRUE)))
   if (!is.null(ocs)) {
    outfile <- paste0("data/", gsub(" ", "_", sp), "_occurrences.gpkg")
    sf::write_sf(ocs, outfile)
  }
  return(ocs)
})

}else{
  species_occs <- lapply(species_names, function(sp) {
    sf::read_sf(paste0("data/", gsub(" ", "_", sp), "_occurrences.gpkg"))
  })
}
names(species_occs) <- gsub(" ", "_", species_names)

fish_occs <- bind_rows(species_occs, .id = "species")

ggplot() + 
  geom_sf(data = bc, color = "lightgrey") + 
  geom_sf(data = fish_occs, aes(color = as.factor(Species)))+
  facet_wrap( ~ Species)+
  scale_color_viridis_d() +
  labs(color = "Species") +
  ggthemes::theme_map()+
  theme(legend.position = "bottom")
  

# now is there an overlap of susceptible fish with the wb_list, for each species, new column with TRUE/FALSE for the species 

fish_occs<-sf::st_transform(fish_occs, 3005)

# Initialize columns for each species in wb_list
for (sp in species_names) {
  wb_list[[sp]] <- FALSE
}

for (sp in species_names) {
  # Filter points for the species
  sp <-gsub(" ", "_", sp)  # Ensure species name matches the column name
  sp_points <- fish_occs[fish_occs$species == sp, ]
  
  # Check which waterbodies intersect with any points of this species
  intersects <- st_intersects(wb_list, sp_points, sparse = FALSE)
  
  # Update the column with TRUE where there's at least one intersecting point
  wb_list[[sp]] <- apply(intersects, 1, any)
}

```
			
			
			
			ix. Add in expert opinion from regions, First Nations, etc., as available
			x. In future, we'll bring in SARA-listed species / COSEWIC

```{r add_together_variables}
wb_list = wb_list |> 
  dplyr::mutate(priority = TotalInspections_bin + insp_from_wd_bc_wb_b + days_fished_bin)
```


### Final Table with Overlayed Data

```{r show_results_data_table}
wb_list |> 
  sf::st_drop_geometry() |> 
  DT::datatable(filter = 'top', options = list(
  pageLength = 5, autoWidth = TRUE))
```
